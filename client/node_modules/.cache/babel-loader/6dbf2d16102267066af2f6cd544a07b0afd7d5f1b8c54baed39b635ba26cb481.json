{"ast":null,"code":"var _jsxFileName = \"C:\\\\Users\\\\quoct\\\\Data\\\\Exercise D21KTPM\\\\BCKH C\\u1EA5p Vi\\u1EC7n\\\\Semester-1-Year-3\\\\f2c\\\\v1.0.4\\\\client\\\\src\\\\components\\\\PostList.js\",\n  _s = $RefreshSig$();\nimport React, { useState, useEffect } from \"react\";\nimport Post from \"./Post\";\nimport io from \"socket.io-client\";\nimport InfiniteScroll from \"react-infinite-scroll-component\";\nimport { getLimitPost, getNumberPost } from \"../adapters/post\";\nimport { jsxDEV as _jsxDEV } from \"react/jsx-dev-runtime\";\nconst server = process.env.REACT_APP_SEVER_IP + \":\" + process.env.REACT_APP_SERVER_SOCKET;\nconst socket = io(server, {\n  transports: [\"websocket\"]\n});\nexport default function PostList() {\n  _s();\n  const [maxPost, setMaxPost] = useState(0);\n  const [fromPage, setFromPage] = useState(1);\n  const [limitPost, setLimitPost] = useState(2);\n  const [post, setPost] = useState([]);\n  const [hasMore, setHasMore] = useState(false);\n\n  // LOAD POST ONE TIME\n  useEffect(() => {\n    fetchData(fromPage - 1, limitPost);\n    getMaxPost();\n  }, []);\n  useEffect(() => {\n    function handlePostAdded(newPost) {\n      const newList = [newPost, ...post];\n      setPost(newList);\n    }\n    function handleCommentAdded(newComment) {\n      setPost(prevPost => {\n        const updatedPost = prevPost.map(postItem => {\n          if (postItem._id === newComment.postID) {\n            // Nếu postID trùng khớp với postItem._id, chèn newComment vào đầu mảng comments\n            const updatedComments = [newComment, ...postItem.comments];\n            return {\n              ...postItem,\n              comments: updatedComments\n            };\n          }\n          return postItem;\n        });\n        return updatedPost; // React sẽ tự động cập nhật lại trạng thái post với updatedPost\n      });\n    }\n\n    socket.on(\"postAdded\", handlePostAdded);\n    socket.on(\"commentAdded\", handleCommentAdded);\n    return () => {\n      socket.off(\"postAdded\", handlePostAdded);\n      socket.off(\"commentAdded\", handleCommentAdded);\n    };\n  }, [post]);\n  async function getMaxPost() {\n    const MAXPOST = await getNumberPost();\n    setMaxPost(MAXPOST.numberPost);\n    if (MAXPOST.numberPost > 0) setHasMore(true);\n  }\n  async function fetchData(fromPage, toPage) {\n    // Gửi thông báo đến server để lấy bài viết\n    const data = await getLimitPost(fromPage, toPage);\n    setPost(data);\n  }\n  async function fetchMoreData() {\n    if (post.length === maxPost) {\n      setHasMore(false);\n      return;\n    }\n    setTimeout(async () => {\n      const toPost = post.length + limitPost;\n\n      // Lấy thêm dữ liệu\n      const data = await getLimitPost(post.length, toPost);\n      const newData = post.concat(data);\n      setPost(newData);\n    }, 900);\n    /* Độ trễ phải từ 900 trở lên để server kịp xử lý, \r\n    // xảy ra khi infinite scroll hoạt động sẽ lấy dữ liệu từ db\r\n    Nếu tốc độ scroll nhanh hơn dẫn tới việc dữ liệu vừa được xóa xong (client) \r\n    vừa cập nhật xong thì infinite scroll gọi lại\r\n    */\n  }\n\n  return /*#__PURE__*/_jsxDEV(InfiniteScroll, {\n    dataLength: post.length,\n    next: fetchMoreData,\n    hasMore: hasMore,\n    loader: /*#__PURE__*/_jsxDEV(\"h4\", {\n      children: \"Loading...\"\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 108,\n      columnNumber: 21\n    }, this),\n    scrollableTarget: \"content\",\n    children: post.map((item, index) => /*#__PURE__*/_jsxDEV(Post, {\n      _id: item._id,\n      sender: item.sender,\n      content: {\n        text: item.content.text,\n        image: item.content.image !== \"\" ? `http://127.0.0.1:3001/uploads/${item.content.image}` : \"\"\n      },\n      creationTime: item.creationTime,\n      comments: item.comments,\n      post: post,\n      setPost: setPost\n    }, index, false, {\n      fileName: _jsxFileName,\n      lineNumber: 113,\n      columnNumber: 21\n    }, this))\n  }, void 0, false, {\n    fileName: _jsxFileName,\n    lineNumber: 104,\n    columnNumber: 9\n  }, this);\n}\n_s(PostList, \"43AQ82hPGo1elM/mwMA46As6mYk=\");\n_c = PostList;\nvar _c;\n$RefreshReg$(_c, \"PostList\");","map":{"version":3,"names":["React","useState","useEffect","Post","io","InfiniteScroll","getLimitPost","getNumberPost","jsxDEV","_jsxDEV","server","process","env","REACT_APP_SEVER_IP","REACT_APP_SERVER_SOCKET","socket","transports","PostList","_s","maxPost","setMaxPost","fromPage","setFromPage","limitPost","setLimitPost","post","setPost","hasMore","setHasMore","fetchData","getMaxPost","handlePostAdded","newPost","newList","handleCommentAdded","newComment","prevPost","updatedPost","map","postItem","_id","postID","updatedComments","comments","on","off","MAXPOST","numberPost","toPage","data","fetchMoreData","length","setTimeout","toPost","newData","concat","dataLength","next","loader","children","fileName","_jsxFileName","lineNumber","columnNumber","scrollableTarget","item","index","sender","content","text","image","creationTime","_c","$RefreshReg$"],"sources":["C:/Users/quoct/Data/Exercise D21KTPM/BCKH Cấp Viện/Semester-1-Year-3/f2c/v1.0.4/client/src/components/PostList.js"],"sourcesContent":["import React, { useState, useEffect } from \"react\";\r\nimport Post from \"./Post\";\r\nimport io from \"socket.io-client\";\r\nimport InfiniteScroll from \"react-infinite-scroll-component\";\r\nimport { getLimitPost, getNumberPost } from \"../adapters/post\";\r\n\r\nconst server =\r\n    process.env.REACT_APP_SEVER_IP + \":\" +\r\n    process.env.REACT_APP_SERVER_SOCKET\r\n\r\nconst socket = io(server, { transports: [\"websocket\"] });\r\n\r\nexport default function PostList() {\r\n    const [maxPost, setMaxPost] = useState(0)\r\n    const [fromPage, setFromPage] = useState(1)\r\n    const [limitPost, setLimitPost] = useState(2)\r\n    const [post, setPost] = useState([]);\r\n    const [hasMore, setHasMore] = useState(false)\r\n\r\n    // LOAD POST ONE TIME\r\n    useEffect(() => {\r\n        fetchData(fromPage - 1, limitPost);\r\n\r\n        getMaxPost();\r\n\r\n    }, [])\r\n\r\n    useEffect(() => {\r\n\r\n        function handlePostAdded(newPost) {\r\n            const newList = [newPost, ...post]\r\n\r\n            setPost(newList)\r\n\r\n        }\r\n\r\n        function handleCommentAdded(newComment) {\r\n            setPost((prevPost) => {\r\n                const updatedPost = prevPost.map((postItem) => {\r\n                    if (postItem._id === newComment.postID) {\r\n                        // Nếu postID trùng khớp với postItem._id, chèn newComment vào đầu mảng comments\r\n                        const updatedComments = [newComment, ...postItem.comments];\r\n                        return {\r\n                            ...postItem,\r\n                            comments: updatedComments,\r\n                        };\r\n                    }\r\n                    return postItem;\r\n                });\r\n                return updatedPost; // React sẽ tự động cập nhật lại trạng thái post với updatedPost\r\n            });\r\n        }\r\n\r\n        socket.on(\"postAdded\", handlePostAdded)\r\n        socket.on(\"commentAdded\", handleCommentAdded)\r\n\r\n        return () => {\r\n            socket.off(\"postAdded\", handlePostAdded)\r\n            socket.off(\"commentAdded\", handleCommentAdded)\r\n        }\r\n\r\n    }, [post]);\r\n\r\n    async function getMaxPost() {\r\n        const MAXPOST = await getNumberPost()\r\n\r\n        setMaxPost(MAXPOST.numberPost)\r\n\r\n        if (MAXPOST.numberPost > 0)\r\n            setHasMore(true)\r\n    }\r\n\r\n    async function fetchData(fromPage, toPage) {\r\n        // Gửi thông báo đến server để lấy bài viết\r\n        const data = await getLimitPost(fromPage, toPage)\r\n\r\n        setPost(data)\r\n    }\r\n\r\n    async function fetchMoreData() {\r\n        if (post.length === maxPost) {\r\n            setHasMore(false)\r\n            return\r\n        }\r\n\r\n        setTimeout(async () => {\r\n            const toPost = post.length + limitPost\r\n\r\n            // Lấy thêm dữ liệu\r\n            const data = await getLimitPost(post.length, toPost);\r\n            const newData = post.concat(data)\r\n\r\n            setPost(newData)\r\n\r\n        }, (900));\r\n        /* Độ trễ phải từ 900 trở lên để server kịp xử lý, \r\n        // xảy ra khi infinite scroll hoạt động sẽ lấy dữ liệu từ db\r\n        Nếu tốc độ scroll nhanh hơn dẫn tới việc dữ liệu vừa được xóa xong (client) \r\n        vừa cập nhật xong thì infinite scroll gọi lại\r\n        */\r\n    }\r\n\r\n    return (\r\n        <InfiniteScroll\r\n            dataLength={post.length}\r\n            next={fetchMoreData}\r\n            hasMore={hasMore}\r\n            loader={<h4>Loading...</h4>}\r\n            scrollableTarget=\"content\"\r\n        >\r\n            {\r\n                post.map((item, index) => (\r\n                    <Post\r\n                        key={index}\r\n\r\n                        _id={item._id}\r\n\r\n                        sender={item.sender}\r\n\r\n                        content={{\r\n                            text: item.content.text,\r\n                            image: item.content.image !== \"\" ? `http://127.0.0.1:3001/uploads/${item.content.image}` : \"\",\r\n                        }}\r\n\r\n                        creationTime={item.creationTime}\r\n\r\n                        comments={item.comments}\r\n\r\n                        post={post}\r\n\r\n                        setPost={setPost}\r\n                    />\r\n                ))\r\n            }\r\n        </InfiniteScroll>\r\n    );\r\n}"],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}